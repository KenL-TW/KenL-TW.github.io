<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Blog | Ken Liao</title>
  <meta name="description" content="Ken Liao 的技術部落格與教學文章彙整與全文搜尋。">
  <link rel="canonical" href="https://kenl-tw.github.io/blog/blog.html" />

  <style>
    :root{--c:#0b5fff}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Noto Sans',sans-serif; margin:0; color:#222; background:#fafafa}
    .container{max-width:960px;margin:0 auto;padding:24px 16px}
    .header{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
    .search{flex:1 1 320px;display:flex;gap:8px}
    .search input{flex:1;padding:10px 12px;border:1px solid #e2e2e2;border-radius:10px}
    .tags{display:flex;flex-wrap:wrap;gap:8px;margin:12px 0 20px}
    .tag{padding:6px 10px;border-radius:999px;border:1px solid #e2e2e2;background:#fff;cursor:pointer;font-size:14px}
    .tag.active{background:var(--c);color:#fff;border-color:var(--c)}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px}
    .card{background:#fff;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.06);overflow:hidden;display:flex;flex-direction:column}
    .cover{height:160px;object-fit:cover;width:100%;display:block;background:#f2f3f5}
    .body{padding:14px 14px 16px;display:flex;flex-direction:column;gap:8px}
    .title{margin:0;font-size:18px;line-height:1.35}
    .meta{color:#666;font-size:14px}
    .excerpt{color:#444;font-size:14px}
    .badge{display:inline-block;background:#eef2ff;color:#223;border-radius:999px;padding:2px 8px;margin-right:6px;font-size:12px}
    .btn{align-self:flex-start;padding:8px 12px;border-radius:10px;border:1px solid var(--c);color:var(--c);text-decoration:none}
    .btn:hover{background:var(--c);color:#fff}
    .muted{color:#777}
    .empty{padding:24px;border:1px dashed #e2e2e2;border-radius:12px;background:#fff;text-align:center}
    .back-home{position:fixed;right:16px;bottom:16px;z-index:50}
    .back-home a{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;background:#2563eb;color:#fff;border-radius:999px;text-decoration:none;box-shadow:0 4px 16px rgba(37,99,235,.12)}
    .back-home a:hover{background:#1d4ed8}
    /* blog.content 內容樣式可在此擴充 */
    .blog-content {margin:32px 0;}
    .blog-content h2 {font-size:1.3em;margin:24px 0 12px;}
    .blog-content p {margin:8px 0;}
    .blog-content ul, .blog-content ol {margin:12px 0 12px 24px;}
    .blog-content img {max-width:100%;border-radius:8px;margin:16px 0;}
    .blog-content pre {background:#f6f8fa;padding:12px;border-radius:8px;overflow-x:auto;}
  </style>

  <meta property="og:type" content="website">
  <meta property="og:title" content="Blog | Ken Liao">
  <meta property="og:description" content="Ken Liao 的技術部落格與教學文章彙整與全文搜尋。">
  <meta property="og:image" content="https://kenl-tw.github.io/assets/img/profile-img.png">
  <meta property="og:url" content="https://kenl-tw.github.io/blog.html">
  <meta name="twitter:card" content="summary_large_image">

  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
</head>
<body>
  <!-- 返回首頁 -->
  <div class="back-home">
    <a href="../index.html" aria-label="返回首頁">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
      </svg>
      返回首頁
    </a>
  </div>

  <div class="container">
    <div class="header">
      <h1 style="margin:0">部落格文章</h1>
      <div class="search">
        <input id="q" type="search" placeholder="搜尋標題 / 摘要 / 標籤…" aria-label="搜尋">
        <button id="clear" type="button" class="btn">清除</button>
      </div>
    </div>

    <div class="tags" id="tag-cloud" aria-label="標籤雲"></div>

    <div id="result-count" class="muted" style="margin-bottom:10px"></div>
    <div class="grid" id="list"></div>
    <div id="empty" class="empty" style="display:none">找不到符合的文章，試試其他關鍵字或標籤。</div>
  </div>

  <script>
    // ===== 先宣告這兩個工具，避免未定義錯誤 =====
    const IN_BLOG = location.pathname.toLowerCase().includes('/blog/');
    const IS_FILE = location.protocol === 'file:';
    function resolveCover(url){
      if(!url) return '';
      let u = String(url);

      // 完整 URL 直接用
      if(/^https?:\/\//i.test(u) || /^\/\//.test(u)) return u;

      // 本機 file:// 時，避免以 "/" 開頭變成磁碟根
      if(IS_FILE && u.startsWith('/')) u = u.replace(/^\//,''); 

      // 若在 /blog/ 子資料夾，幫相對路徑補 "../"
      if(IN_BLOG && !u.startsWith('../')) u = '../' + u;

      return u;
    }
    window.addEventListener('error', e => console.error('[Blog Error]', e.error || e.message));

    // ===== 資料載入 =====
    const USE_FETCH = location.protocol !== 'file:';
    const IMG = (name) => `assets/img/blog/${name}.png`;

    const POSTS_INLINE = [
      { slug:"hello-world",     title:"從零打造個人部落格（純前端架構）", date:"2025-10-08", tags:["blog","web","portfolio"], excerpt:"純 HTML + JS + GitHub Pages，輕巧可維護。", cover: IMG("hello-world") },
      { slug:"system-analysis", title:"系統分析師的思維與方法論",         date:"2025-09-25", tags:["analysis","career"],       excerpt:"需求、架構與交付之間的平衡術。",           cover: IMG("system-analysis") },
      { slug:"network-attack",  title:"網路攻擊視覺化分享",               date:"2025-08-31", tags:["tutorials","security"],    excerpt:"用動畫拆解 SQLi 與 XSS。",              cover: IMG("network-attack") },
      { slug:"networkAttack",  title:"網路攻擊視覺化分享",               date:"2025-08-31", tags:["tutorials","security"],    excerpt:"用動畫拆解 SQLi 與 XSS。",              cover: IMG("network-attack") }
    ];

    async function loadPosts(){
      if(!USE_FETCH) return POSTS_INLINE;
      try{
        const r = await fetch('./posts.json',{cache:'no-store'});
        if(!r.ok) throw new Error('HTTP '+r.status);
        return await r.json();
      }catch(err){
        console.warn('[loadPosts] fallback to inline:', err);
        return POSTS_INLINE;
      }
    }

    // ===== 狀態 =====
    let POSTS = [];
    let fuse;
    let activeTag = 'all';

    // ===== 初始化 =====
    (async function init(){
      POSTS = (await loadPosts()).filter(p=>p?.slug && p?.title);
      POSTS.sort((a,b)=> String(b.date).localeCompare(String(a.date)));

      fuse = new Fuse(POSTS, {
        includeScore:true,
        threshold:0.38,
        keys:[ {name:'title',weight:0.55}, {name:'excerpt',weight:0.30}, {name:'tags',weight:0.15} ]
      });

      const url = new URL(location.href);
      const q0 = url.searchParams.get('q') || '';
      const t0 = url.searchParams.get('tag') || 'all';
      document.getElementById('q').value = q0;
      activeTag = t0;

      buildTagCloud();
      applyFilters();
      bindSearch();
    })();

    // ===== 標籤雲 =====
    function buildTagCloud(){
      const el = document.getElementById('tag-cloud');
      const counts = {};
      POSTS.forEach(p => (p.tags||[]).forEach(t => counts[t]=(counts[t]||0)+1));
      const tags = Object.entries(counts).sort((a,b)=>b[1]-a[1]).map(([t])=>t);
      el.innerHTML = [`<button class="tag ${activeTag==='all'?'active':''}" data-tag="all">全部</button>`]
        .concat(tags.map(t=>`<button class="tag ${activeTag===t?'active':''}" data-tag="${escapeHtml(t)}">${escapeHtml(t)}</button>`))
        .join('');
      el.addEventListener('click', e=>{
        const btn = e.target.closest('.tag'); if(!btn) return;
        el.querySelectorAll('.tag').forEach(n=>n.classList.remove('active'));
        btn.classList.add('active');
        activeTag = btn.dataset.tag;
        syncQueryParams();
        applyFilters();
      });
    }

    // ===== 搜尋 =====
    function bindSearch(){
      const q = document.getElementById('q');
      const clear = document.getElementById('clear');
      q.addEventListener('input', ()=>{ syncQueryParams(); applyFilters(); });
      clear.addEventListener('click', ()=>{
        q.value=''; activeTag='all';
        document.querySelectorAll('#tag-cloud .tag').forEach(n=>n.classList.remove('active'));
        const all = document.querySelector('#tag-cloud .tag[data-tag="all"]'); if(all) all.classList.add('active');
        syncQueryParams(); applyFilters(); q.focus();
      });
    }

    // ===== 過濾並渲染 =====
    function applyFilters(){
      const q = document.getElementById('q').value.trim();
      let rows = POSTS;
      if(q){ rows = fuse.search(q).map(r=>r.item); }
      if(activeTag!=='all'){ rows = rows.filter(p=> (p.tags||[]).includes(activeTag)); }
      renderList(rows, q);
    }

    function renderList(rows, q=''){
      const list = document.getElementById('list');
      const empty = document.getElementById('empty');
      const count = document.getElementById('result-count');

      if(!rows.length){
        list.innerHTML = '';
        empty.style.display = 'block';
        count.textContent = '0 篇文章';
        return;
      }
      empty.style.display = 'none';
      count.textContent = `${rows.length} 篇文章${q?`（關鍵字：「${q}」）`:''}`;

      list.innerHTML = rows.map(p=>`
        <article class="card" itemscope itemtype="https://schema.org/BlogPosting">
          <img class="cover" src="${resolveCover(p.cover)}" alt="${escapeHtml(p.title)} 封面"
               loading="lazy" width="640" height="360" itemprop="image"
               onerror="console.warn('封面載入失敗：', this.src); this.removeAttribute('src'); this.style.background='#eee'">
          <div class="body">
            <h2 class="title" itemprop="headline">${p.title}</h2>
            <div class="meta"><time itemprop="datePublished" datetime="${p.date}">${p.date}</time></div>
            <p class="excerpt" itemprop="description">${p.excerpt||''}</p>
            <div>${(p.tags||[]).slice(0,4).map(t=>`<span class="badge">#${t}</span>`).join('')}</div>
            <a class="btn" href="post.html?slug=${encodeURIComponent(p.slug)}" itemprop="url">閱讀更多</a>
          </div>
        </article>
      `).join('');

      injectItemListLD(rows);
    }

    // ===== SEO JSON-LD =====
    function injectItemListLD(rows){
      document.querySelectorAll('script[data-ld=itemlist]').forEach(n=>n.remove());
      const ld = {
        "@context":"https://schema.org",
        "@type":"ItemList",
        "itemListElement": rows.map((p,i)=>({
          "@type":"ListItem","position":i+1,
          "url": (location.origin || '') + "/blog/post.html?slug=" + p.slug
        }))
      };
      const s = document.createElement('script');
      s.type='application/ld+json';
      s.dataset.ld='itemlist';
      s.textContent = JSON.stringify(ld);
      document.head.appendChild(s);
    }

    function syncQueryParams(){
      const q = document.getElementById('q').value.trim();
      const url = new URL(location.href);
      if(q) url.searchParams.set('q', q); else url.searchParams.delete('q');
      if(activeTag && activeTag!=='all') url.searchParams.set('tag', activeTag); else url.searchParams.delete('tag');
      history.replaceState(null, '', url.toString());
    }

    function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
  </script>
</body>
</html>

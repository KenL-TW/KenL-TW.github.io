<template>
  <div class="font-inter">
    <!-- 導覽列組件 -->
    <nav class="bg-gradient-to-r from-blue-600 to-indigo-700 p-4 shadow-lg">
      <div class="container mx-auto flex justify-between items-center">
        <h1 class="text-white text-3xl font-bold font-inter cursor-pointer" @click="currentPage = 'landing'">
          日文面試通
        </h1>
        <div v-if="isAuthReady && user" class="flex items-center space-x-4">
          <img
            v-if="user.photoURL"
            :src="user.photoURL"
            alt="使用者大頭貼"
            class="w-10 h-10 rounded-full border-2 border-white"
            @error="(e) => { e.target.onerror = null; e.target.src = '[https://placehold.co/40x40/cccccc/000000?text=圖片](https://placehold.co/40x40/cccccc/000000?text=圖片)'; }"
          />
          <span class="text-white text-lg font-medium hidden sm:block">
            {{ user.displayName || user.email || "匿名使用者" }}
          </span>
          <button
            @click="signOutUser"
            class="bg-white text-blue-700 px-4 py-2 rounded-full shadow hover:bg-gray-100 transition duration-300 transform hover:scale-105"
          >
            登出
          </button>
        </div>
        <button
          v-else
          @click="signInWithGoogle"
          class="bg-white text-blue-700 px-6 py-2 rounded-full shadow-lg hover:bg-gray-100 transition duration-300 transform hover:scale-105 font-semibold"
        >
          使用 Google 登入
        </button>
      </div>
    </nav>

    <!-- 根據當前頁面渲染對應組件 -->
    <template v-if="!isAuthReady">
      <div class="flex justify-center items-center h-screen bg-gray-100">
        <div class="text-center text-xl text-gray-600">
          載入中，請稍候...
          <svg class="animate-spin ml-3 h-8 w-8 text-blue-500 inline-block" xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        </div>
      </div>
    </template>
    <template v-else>
      <LandingPage v-if="currentPage === 'landing'" @navigate="navigateToPage" />
      <InterviewEssentialsPage v-else-if="currentPage === 'interview-essentials'" />
      <VocabularyUsagePage v-else-if="currentPage === 'vocabulary-usage'" />
      <ResumeReviewPage v-else-if="currentPage === 'resume-review'" :user-id="user?.uid" />
      <ConsultationPage v-else-if="currentPage === 'consultation'" :user="user" @booking-success="handleBookingSuccess" :show-success-message="showBookingSuccess" />
    </template>
  </div>
</template>

<script setup>
import { ref, reactive, onMounted, onUnmounted, defineComponent } from 'vue';
import { initializeApp } from 'firebase/app';
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, signInWithCustomToken, signInAnonymously } from 'firebase/auth';
import { getFirestore, collection, addDoc } from 'firebase/firestore';

// 確保 __app_id, __firebase_config, __initial_auth_token 這些變數在 Canvas 環境中是可用的
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// 初始化 Firebase 應用程式
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// 主要應用程式的狀態
const user = ref(null); // 儲存 Firebase 使用者物件
const currentPage = ref('landing'); // 當前顯示的頁面
const isAuthReady = ref(false); // 標記 Firebase 認證是否準備好
const showBookingSuccess = ref(false); // 控制預約成功訊息顯示

// Firebase 認證狀態監聽
onMounted(() => {
  const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
    if (initialAuthToken && !currentUser) {
      try {
        // 如果有初始認證 token 且使用者未登入，嘗試使用 token 登入
        await signInWithCustomToken(auth, initialAuthToken);
      } catch (error) {
        console.error("使用自定義 token 登入失敗:", error);
        // 如果自定義 token 登入失敗，則匿名登入以確保內容可存取
        await signInAnonymously(auth);
      }
    } else if (!currentUser) {
      // 如果沒有初始認證 token 且使用者未登入，則匿名登入以確保內容可存取
      await signInAnonymously(auth);
    }
    user.value = currentUser; // 設定使用者狀態
    isAuthReady.value = true; // 標記認證準備就緒
  });

  onUnmounted(() => unsubscribe()); // 清理監聽器
});

// Google 登入功能
const signInWithGoogle = async () => {
  const provider = new GoogleAuthProvider();
  try {
    await signInWithPopup(auth, provider);
  } catch (error) {
    console.error("Google 登入失敗:", error);
    // 在 UI 中顯示錯誤訊息，而非使用 alert()
    alert("Google 登入失敗，請稍後再試。");
  }
};

// 登出功能
const signOutUser = async () => {
  try {
    await signOut(auth);
    // 登出後導向首頁
    currentPage.value = 'landing';
  } catch (error) {
    console.error("登出失敗:", error);
    alert("登出失敗，請稍後再試。");
  }
};

// 導覽至特定頁面
const navigateToPage = (pageName) => {
  currentPage.value = pageName;
};

// 處理預約成功的事件
const handleBookingSuccess = () => {
  showBookingSuccess.value = true;
  setTimeout(() => {
    showBookingSuccess.value = false;
  }, 3000); // 3 秒後隱藏成功訊息
};

// --- 子組件定義 ---

// 可折疊區塊組件 (CollapsibleSection)
const CollapsibleSection = defineComponent({
  props: {
    title: String,
  },
  setup(props, { slots }) {
    const isOpen = ref(false);
    return {
      isOpen,
      toggleOpen: () => (isOpen.value = !isOpen.value),
      slots, // 暴露 slots 供父組件使用
    };
  },
  template: `
    <div class="mb-4 bg-gray-100 p-4 rounded-lg shadow-sm">
      <button
        class="flex justify-between items-center w-full text-left text-xl font-semibold text-blue-700"
        @click="toggleOpen"
      >
        {{ title }}
        <span>{{ isOpen ? '▲' : '▼' }}</span>
      </button>
      <div v-if="isOpen" class="mt-4 text-gray-800">
        <slot></slot>
      </div>
    </div>
  `,
});

// 通用區塊卡片組件 (SectionCard)
const SectionCard = defineComponent({
  props: {
    title: String,
    description: String,
    color: String,
  },
  setup(props, { slots }) {
    return {
      props,
      slots,
    };
  },
  template: `
    <div :class="['mb-8 bg-white rounded-xl shadow-md overflow-hidden border-l-8', props.color]">
      <div class="p-6">
        <h3 class="text-3xl font-bold text-gray-800 mb-3">{{ props.title }}</h3>
        <p class="text-gray-600 text-lg mb-4">{{ props.description }}</p>
        <div class="text-gray-700 text-base leading-relaxed">
          <slot></slot>
        </div>
      </div>
    </div>
  `,
});

// 功能卡片組件 (FeatureCard)
const FeatureCard = defineComponent({
  props: {
    icon: String,
    title: String,
    description: String,
    onClick: Function,
  },
  template: `
    <div
      class="bg-white rounded-xl shadow-lg p-6 flex flex-col items-center text-center transition duration-300 transform hover:scale-105 hover:shadow-2xl cursor-pointer"
      @click="onClick"
    >
      <div class="text-6xl mb-4">{{ icon }}</div>
      <h3 class="text-2xl font-bold text-gray-800 mb-2">{{ title }}</h3>
      <p class="text-gray-600 mb-4">{{ description }}</p>
      <button
        class="mt-auto px-6 py-2 rounded-full font-semibold bg-blue-500 text-white hover:bg-blue-600"
      >
        了解更多
      </button>
    </div>
  `,
});

// 首頁組件 (LandingPage)
const LandingPage = defineComponent({
  emits: ['navigate'],
  components: { FeatureCard },
  setup(props, { emit }) {
    const navigate = (pageName) => {
      emit('navigate', pageName);
    };
    return { navigate };
  },
  template: `
    <div class="min-h-screen bg-gray-50 py-12 flex flex-col items-center">
      <header class="text-center mb-12 px-4">
        <h2 class="text-5xl md:text-6xl font-extrabold text-blue-800 mb-4 tracking-tight">
          日文面試成功，從這裡開始！
        </h2>
        <p class="text-xl md:text-2xl text-gray-600 max-w-2xl mx-auto leading-relaxed">
          為您量身打造的日文面試準備平台，助您自信應對，職涯起飛。
        </p>
      </header>

      <div class="flex flex-col sm:flex-row space-y-6 sm:space-y-0 sm:space-x-6 mb-16">
        <button
          @click="navigate('interview-essentials')"
          class="bg-blue-600 text-white px-10 py-5 rounded-full text-2xl font-bold shadow-xl hover:bg-blue-700 transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300"
        >
          面試準備
        </button>
        <button
          @click="navigate('resume-review')"
          class="bg-indigo-600 text-white px-10 py-5 rounded-full text-2xl font-bold shadow-xl hover:bg-indigo-700 transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-indigo-300"
        >
          履歷審核
        </button>
      </div>

      <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 px-8 max-w-6xl mx-auto">
        <FeatureCard
          icon="📚"
          title="面試精華"
          description="涵蓋面試技巧、禮儀與策略，助您脫穎而出。"
          :on-click="() => navigate('interview-essentials')"
        />
        <FeatureCard
          icon="📝"
          title="用詞用具"
          description="專注日文敬語與商務詞彙，精準表達不失禮。"
          :on-click="() => navigate('vocabulary-usage')"
        />
        <FeatureCard
          icon="🤖"
          title="AI 履歷審核"
          description="模擬 AI 摘要履歷，快速掌握重點與亮點。"
          :on-click="() => navigate('resume-review')"
        />
        <FeatureCard
          icon="🤝"
          title="免費諮詢"
          description="預約一對一專業指導，個人化解決您的疑問。"
          :on-click="() => navigate('consultation')"
        />
      </section>
    </div>
  `,
});

// 日文面試準備精華頁組件 (InterviewEssentialsPage)
const InterviewEssentialsPage = defineComponent({
  components: { SectionCard, CollapsibleSection },
  setup() {
    const mockAnswer = ref('');
    const sampleSelfIntro = `〇〇と申します。これまではソフトウェア開発の分野で、5年間、フロントエンドとバックエンドの両方で経験を積んでまいりました。特にReactとNode.jsを用いたWebアプリケーションの開発に強みがあります。御社の革新的なAI技術を活用したプロダクト開発に魅力を感じ、これまでの経験と技術を活かして貢献したいと考えております。`;

    const checkAnswer = () => {
      if (!mockAnswer.value.trim()) {
        alert('請輸入您的回答進行模擬！');
        return;
      }
      alert('您的回答已提交進行模擬分析（此為模擬功能，無實際分析）。');
      // 實際應用中可以在這裡呼叫 AI 進行分析
    };

    return {
      mockAnswer,
      sampleSelfIntro,
      checkAnswer,
    };
  },
  template: `
    <div class="min-h-screen bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
      <div class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-lg">
        <h2 class="text-4xl font-bold text-blue-700 mb-8 text-center">日文面試準備精華</h2>

        <SectionCard
          title="常見面試問題與範例回答"
          description="掌握核心問題，準備萬無一失的回答。"
          color="border-l-blue-500"
        >
          <CollapsibleSection title="1. 自我介紹 (自己紹介)">
            <p class="mb-2">
              範例：
              <span class="italic text-gray-700">
                「〇〇と申します。これまでは〇〇の分野で、〇〇の経験を積んでまいりました。貴社の〇〇という点に魅力を感じ、これまでの経験を活かして貢献したいと考えております。」
              </span>
            </p>
            <p>
              要點：簡潔明瞭，包含姓名、過往經驗、志望動機、如何貢獻。
            </p>
          </CollapsibleSection>
          <CollapsibleSection title="2. 志望動機 (志望動機)">
            <p class="mb-2">
              範例：
              <span class="italic text-gray-700">
                「貴社の〇〇という事業展開に深く共感し、特に〇〇のプロジェクトに強い関心を持っております。私の〇〇のスキルが、貴社の目標達成に貢献できると確信しております。」
              </span>
            </p>
            <p>
              要點：表達對公司的理解與熱情，連結個人能力與公司需求。
            </p>
          </CollapsibleSection>
          <CollapsibleSection title="3. 強項與弱項 (長所と短所)">
            <p class="mb-2">
              強項範例：<span class="italic text-gray-700">「私の長所は、問題解決能力が高い点です。〇〇プロジェクトで〇〇の課題に直面した際、〇〇なアプローチで解決し、〇〇の成果を上げました。」</span>
            </p>
            <p class="mb-2">
              弱項範例：<span class="italic text-gray-700">「私の短所は、完璧主義な傾向がある点です。しかし、最近は計画段階で優先順位をつけ、効率的に進めることを意識することで改善しています。」</span>
            </p>
            <p>要點：強項要舉例，弱項要說明如何改進。</p>
          </CollapsibleSection>
        </SectionCard>

        <SectionCard
          title="模擬面試練習"
          description="輸入您的回答，進行自我評估。"
          color="border-l-orange-500"
        >
          <p class="text-lg font-medium mb-3">問題：請用日文進行自我介紹（約 1 分鐘）。</p>
          <textarea
            class="w-full p-3 border border-gray-300 rounded-lg h-32 focus:ring-blue-500 focus:border-blue-500 text-gray-800"
            placeholder="請在此輸入您的日文自我介紹..."
            v-model="mockAnswer"
          ></textarea>
          <button
            @click="checkAnswer"
            class="mt-4 bg-green-600 text-white px-6 py-3 rounded-full text-lg font-semibold shadow-md hover:bg-green-700 transition duration-300 transform hover:scale-105"
          >
            模擬回答評估 (點擊此處)
          </button>
          <CollapsibleSection title="參考範例回答">
            <p class="whitespace-pre-wrap">{{ sampleSelfIntro }}</p>
          </CollapsibleSection>
        </SectionCard>

        <SectionCard
          title="面試禮儀與注意事項"
          description="細節決定成敗，展現您的專業度。"
          color="border-l-green-500"
        >
          <CollapsibleSection title="1. 服裝儀容">
            <ul class="list-disc list-inside text-gray-700 mb-2">
              <li>男士：深色西裝、白襯衫、素色領帶，整潔的髮型。</li>
              <li>女士：深色套裝、內搭襯衫，避免過度妝容與飾品，髮型整齊。</li>
            </ul>
          </CollapsibleSection>
          <CollapsibleSection title="2. 問候語與入座時機">
            <p class="mb-2">
              進入面試室時：<span class="italic text-gray-700">「失礼いたします。」</span>
            </p>
            <p>
              就座前：等待面試官指示 <span class="italic text-gray-700">「どうぞおかけください」</span> 後再入座。
            </p>
          </CollapsibleSection>
          <CollapsibleSection title="3. 眼神交流與肢體語言">
            <p class="mb-2">
              眼神：與面試官保持適度眼神交流，不必長時間直視。
            </p>
            <p>
              肢體：坐姿端正，雙手可輕放在膝上，避免頻繁小動作。
            </p>
          </CollapsibleSection>
        </SectionCard>

        <SectionCard
          title="產業別面試重點"
          description="針對不同行業，提供專屬面試建議。"
          color="border-l-purple-500"
        >
          <CollapsibleSection title="1. IT 產業">
            <p class="mb-2">重點：技術能力、解決問題能力、團隊合作、對新技術的學習熱情。</p>
            <p>
              常用詞彙：アジャイル (Agile)、クラウド (Cloud)、デプロイ (Deploy)、フレームワーク (Framework)。
            </p>
          </CollapsibleSection>
          <CollapsibleSection title="2. 貿易/商社">
            <p class="mb-2">重點：溝通能力、談判技巧、語學能力、國際視野、抗壓性。</p>
            <p>
              常用詞彙：サプライチェーン (Supply Chain)、交渉 (Negotiation)、市場調査 (Market Research)。
            </p>
          </CollapsibleSection>
        </SectionCard>
      </div>
    </div>
  `,
});

// 用詞用具準備頁組件 (VocabularyUsagePage)
const VocabularyUsagePage = defineComponent({
  components: { SectionCard, CollapsibleSection },
  setup() {
    const quizQuestions = reactive([
      {
        question: "下列哪一個是「行く (去)」的尊敬語？",
        options: ["参る", "申す", "いらっしゃる", "ございます"],
        answer: "いらっしゃる"
      },
      {
        question: "當對方說「お世話になっております」時，最恰當的回應是？",
        options: ["どういたしまして", "こちらこそお世話になっております", "はい、そうです", "分かりました"],
        answer: "こちらこそお世話になっております"
      },
      {
        question: "「資料」的日文商務常用詞彙是什麼？",
        options: ["しりょう", "データ", "マニュアル", "ドキュメント"],
        answer: "しりょう"
      }
    ]);

    const currentQuestionIndex = ref(0);
    const showQuizResult = ref(false);
    const correctAnswers = ref(0);
    const selectedOption = ref('');

    const handleOptionSelect = (option) => {
      selectedOption.value = option;
    };

    const checkAnswer = () => {
      if (selectedOption.value === quizQuestions[currentQuestionIndex.value].answer) {
        correctAnswers.value++;
      }
      showQuizResult.value = true;
    };

    const nextQuestion = () => {
      showQuizResult.value = false;
      selectedOption.value = '';
      if (currentQuestionIndex.value < quizQuestions.length - 1) {
        currentQuestionIndex.value++;
      } else {
        alert(`測驗結束！您答對了 ${correctAnswers.value} 題，共 ${quizQuestions.length} 題。`);
        currentQuestionIndex.value = 0; // 重設測驗
        correctAnswers.value = 0;
      }
    };

    return {
      quizQuestions,
      currentQuestionIndex,
      showQuizResult,
      correctAnswers,
      selectedOption,
      handleOptionSelect,
      checkAnswer,
      nextQuestion,
    };
  },
  template: `
    <div class="min-h-screen bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
      <div class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-lg">
        <h2 class="text-4xl font-bold text-blue-700 mb-8 text-center">用詞用具準備</h2>

        <SectionCard
          title="敬語用法精解"
          description="日文敬語是職場溝通的關鍵，正確使用展現您的專業。"
          color="border-l-red-500"
        >
          <CollapsibleSection title="1. 尊敬語 (そんけいご)">
            <p class="mb-2">
              用於抬高對方（長輩、客戶、上司）的動作或狀態。
              <br />
              例：行く → いらっしゃる (去)；食べる → 召し上がる (吃)；言う → おっしゃる (說)
            </p>
            <p>要點：表示對對方的敬意，用於對方的行為。</p>
          </CollapsibleSection>
          <CollapsibleSection title="2. 謙讓語 (けんじょうご)">
            <p class="mb-2">
              用於降低自己的動作，以示對對方的尊敬。
              <br />
              例：言う → 申す (說)；する → いたす (做)；行く → 参る (去)
            </p>
            <p>要點：表示對方的地位高於自己，用於自己的行為。</p>
          </CollapsibleSection>
          <CollapsibleSection title="3. 丁寧語 (ていねいご)">
            <p class="mb-2">
              最基本的禮貌用語，以「です」「ます」結尾，對任何人都可以使用。
              <br />
              例：本を読む → 本を読みます (讀書)；嬉しい → 嬉しいです (開心)
            </p>
            <p>要點：使語氣更禮貌、客氣。</p>
          </CollapsibleSection>
          <CollapsibleSection title="敬語常見錯誤與避免">
            <p class="mb-2">
              錯誤範例：<span class="italic text-red-600">「お客様が参られました。」</span> (客戶來了，錯誤使用謙讓語)
              <br />
              正確用法：<span class="italic text-green-600">「お客様がいらっしゃいました。」</span> (客戶來了，正確使用尊敬語)
            </p>
            <p>要點：區分清楚對象和行為的主體。</p>
          </CollapsibleSection>
        </SectionCard>

        <SectionCard
          title="詞彙測驗"
          description="測試您對日文商務詞彙和敬語的理解！"
          color="border-l-blue-400"
        >
          <div class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-xl font-bold text-gray-800 mb-4">問題 {{ currentQuestionIndex + 1 }}/{{ quizQuestions.length }}</h3>
            <p class="text-lg mb-4">{{ quizQuestions[currentQuestionIndex].question }}</p>
            <div class="space-y-3">
              <button
                v-for="(option, index) in quizQuestions[currentQuestionIndex].options"
                :key="index"
                @click="handleOptionSelect(option)"
                :class="[
                  'w-full text-left p-3 rounded-lg border-2 transition duration-200',
                  selectedOption === option ? 'bg-blue-100 border-blue-500' : 'bg-gray-50 border-gray-200 hover:border-blue-300',
                  showQuizResult && option === quizQuestions[currentQuestionIndex].answer ? 'border-green-500 bg-green-50' : '',
                  showQuizResult && selectedOption === option && selectedOption !== quizQuestions[currentQuestionIndex].answer ? 'border-red-500 bg-red-50' : ''
                ]"
                :disabled="showQuizResult"
              >
                {{ option }}
              </button>
            </div>
            <button
              v-if="!showQuizResult"
              @click="checkAnswer"
              :disabled="!selectedOption"
              class="mt-6 w-full bg-blue-600 text-white px-6 py-3 rounded-full text-lg font-semibold shadow-md hover:bg-blue-700 transition duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              檢查答案
            </button>
            <button
              v-else
              @click="nextQuestion"
              class="mt-6 w-full bg-green-600 text-white px-6 py-3 rounded-full text-lg font-semibold shadow-md hover:bg-green-700 transition duration-300 transform hover:scale-105"
            >
              {{ currentQuestionIndex < quizQuestions.length - 1 ? '下一題' : '重新開始測驗' }}
            </button>
            <p v-if="showQuizResult" class="mt-4 text-center text-lg font-semibold">
              <span v-if="selectedOption === quizQuestions[currentQuestionIndex].answer" class="text-green-700">正確！</span>
              <span v-else class="text-red-700">錯誤。正確答案是：{{ quizQuestions[currentQuestionIndex].answer }}</span>
            </p>
          </div>
        </SectionCard>

        <SectionCard
          title="常用日文商務詞彙"
          description="熟悉商務用語，讓您溝通無礙。"
          color="border-l-yellow-500"
        >
          <CollapsibleSection title="辦公室用語">
            <ul class="list-disc list-inside text-gray-700 mb-2">
              <li>承知いたしました (かしこまりました): 我明白了/我知道了 (更禮貌)</li>
              <li>恐れ入ります: 不好意思/很抱歉/謝謝 (表達謙遜或感謝)</li>
              <li>お世話になっております: 承蒙關照 (常用於商務往來開頭)</li>
              <li>お疲れ様です: 辛苦了 (用於同事間或上下班問候)</li>
            </ul>
          </CollapsibleSection>
          <CollapsibleSection title="會議與報告相關詞彙">
            <ul class="list-disc list-inside text-gray-700 mb-2">
              <li>議事録 (ぎじろく): 會議記錄</li>
              <li>資料 (しりょう): 資料</li>
              <li>ご意見 (ごいけん): 意見</li>
              <li>検討 (けんとう): 討論/研討</li>
              <li>提案 (ていあん): 提案</li>
            </ul>
          </CollapsibleSection>
        </SectionCard>

        <SectionCard
          title="面試常用句型"
          description="實用句型，讓您在面試中流暢表達。"
          color="border-l-indigo-500"
        >
          <CollapsibleSection title="表達興趣與熱情">
            <ul class="list-disc list-inside text-gray-700 mb-2">
              <li>「〜に興味があります。」(我對...很感興趣。)
                <br />例：「貴社の企業文化に大変興味があります。」</li>
              <li>「〜に魅力を感じました。」(我被...所吸引。)
                <br />例：「御社のチームの協調性に魅力を感じました。」</li>
            </ul>
          </CollapsibleSection>
          <CollapsibleSection title="說明經驗與能力">
            <ul class="list-disc list-inside text-gray-700 mb-2">
              <li>「〜の経験があります。」(我有...的經驗。)
                <br />例：「私はプロジェクト管理の経験があります。」</li>
              <li>「〜が得意です。」(我擅長...)
                <br />例：「私はデータ分析が得意です。」</li>
            </ul>
          </CollapsibleSection>
          <CollapsibleSection title="表達貢獻意願">
            <ul class="list-disc list-inside text-gray-700 mb-2">
              <li>「〜に貢献したいと考えております。」(我希望能對...有所貢獻。)
                <br />例：「私のスキルで貴社の成長に貢献したいと考えております。」</li>
              <li>「〜で貴社に貢献できると確信しております。」(我確信能用...為貴公司貢獻。)
                <br />例：「私の問題解決能力で貴社に貢献できると確信しております。」</li>
            </ul>
          </CollapsibleSection>
        </SectionCard>
      </div>
    </div>
  `,
});

// 履歷審核與 AI 摘要頁組件 (ResumeReviewPage)
const ResumeReviewPage = defineComponent({
  props: {
    userId: String,
  },
  components: { SectionCard, CollapsibleSection },
  setup(props) {
    const selectedFile = ref(null);
    const resumeContent = ref('');
    const aiSummary = ref('');
    const isLoading = ref(false);
    const fileInputRef = ref(null);

    // 處理檔案選擇
    const handleFileChange = (event) => {
      const file = event.target.files[0];
      if (file) {
        selectedFile.value = file;
        aiSummary.value = ''; // 清空舊的摘要

        if (file.type === 'text/plain') {
          const reader = new FileReader();
          reader.onload = (e) => {
            resumeContent.value = e.target.result;
          };
          reader.readAsText(file);
        } else if (file.type === 'application/pdf') {
          // 對於 PDF 檔案，我們只是模擬，不實際解析內容
          resumeContent.value = '這是 PDF 檔案的模擬內容。請注意，實際應用中需要額外的 PDF 解析庫。';
          // 可以在這裡提示用戶，PDF 解析功能需要後端支持或第三方庫
        } else {
          alert('請上傳 .txt 或 .pdf 檔案。');
          selectedFile.value = null;
          resumeContent.value = '';
        }
      }
    };

    // 模擬 AI 摘要
    const simulateAISummary = async () => {
      if (!resumeContent.value) {
        alert('請先上傳履歷文件！');
        return;
      }

      isLoading.value = true;
      aiSummary.value = ''; // 清空舊的摘要

      try {
        const prompt = `請根據以下日文履歷內容，用日文總結其主要技能、經驗和亮點，並將摘要控制在 100 字以內，不包含「以下是履歷的摘要」等開頭語句。\n\n履歷內容：\n${resumeContent.value}`;
        let chatHistory = [];
        chatHistory.push({ role: "user", parts: [{ text: prompt }] });

        const payload = { contents: chatHistory };
        const apiKey = ""; // Canvas 會自動提供此 API key
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const result = await response.json();

        if (result.candidates && result.candidates.length > 0 &&
            result.candidates[0].content && result.candidates[0].content.parts &&
            result.candidates[0].content.parts.length > 0) {
          const text = result.candidates[0].content.parts[0].text;
          aiSummary.value = text;
        } else {
          aiSummary.value = '未能生成摘要。AI 處理失敗或返回了意料之外的內容。';
          console.error('AI 摘要返回的結構不符預期:', result);
        }
      } catch (error) {
        console.error('AI 摘要請求失敗:', error);
        aiSummary.value = '生成摘要時發生錯誤，請稍後再試。';
      } finally {
        isLoading.value = false;
      }
    };

    return {
      selectedFile,
      resumeContent,
      aiSummary,
      isLoading,
      fileInputRef,
      handleFileChange,
      simulateAISummary,
      userId: props.userId,
    };
  },
  template: `
    <div class="min-h-screen bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
      <div class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-lg">
        <h2 class="text-4xl font-bold text-blue-700 mb-8 text-center">履歷審核與 AI 摘要</h2>

        <div class="mb-6 border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-500 transition duration-300">
          <input
            type="file"
            ref="fileInputRef"
            @change="handleFileChange"
            accept=".txt, .pdf"
            class="hidden"
          />
          <button
            @click="fileInputRef.click()"
            class="bg-blue-500 text-white px-6 py-3 rounded-full text-lg font-semibold shadow-md hover:bg-blue-600 transition duration-300 transform hover:scale-105"
          >
            選擇履歷檔案 (.txt 或 .pdf)
          </button>
          <p v-if="selectedFile" class="mt-3 text-gray-700">已選擇檔案: <span class="font-medium">{{ selectedFile.name }}</span></p>
          <p v-if="selectedFile && selectedFile.type === 'application/pdf'" class="mt-2 text-orange-600 text-sm">
            注意：目前僅模擬 PDF 內容，實際解析需要後端支持。
          </p>
        </div>

        <button
          @click="simulateAISummary"
          :disabled="!selectedFile || isLoading"
          class="w-full bg-indigo-600 text-white px-6 py-3 rounded-full text-xl font-bold shadow-lg hover:bg-indigo-700 transition duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center"
        >
          <template v-if="isLoading">
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            AI 正在摘要中...
          </template>
          <template v-else>
            AI 摘要履歷
          </template>
        </button>

        <div v-if="aiSummary" class="mt-8 p-6 bg-blue-50 border-l-4 border-blue-400 rounded-lg shadow-inner">
          <h3 class="text-2xl font-bold text-blue-800 mb-4">模擬 AI 摘要結果</h3>
          <p class="text-gray-800 leading-relaxed whitespace-pre-wrap">{{ aiSummary }}</p>
          <p class="mt-4 text-sm text-gray-600 italic">
            （此為模擬 AI 摘要，實際應用需謹慎，請以您的判斷為準。）
          </p>
        </div>

        <SectionCard
          title="履歷改進建議"
          description="基於常見問題，提供履歷撰寫的通用建議。"
          color="border-l-green-500"
        >
          <CollapsibleSection title="重點突出，簡潔明瞭">
            <p>
              履歷應強調與目標職位相關的技能和經驗。使用條列式和動詞開頭的句子，讓招聘者能快速捕捉關鍵資訊。避免冗長的描述。
            </p>
          </CollapsibleSection>
          <CollapsibleSection title="量化成就，而非僅描述職責">
            <p>
              盡可能用數字或具體案例來量化您的成就。例如，不要只寫「負責專案管理」，而是寫「成功管理三個專案，將交付時間縮短 15%」。
            </p>
          </CollapsibleSection>
          <CollapsibleSection title="關鍵詞優化">
            <p>
              研究目標職位的 JD (職位描述)，找出關鍵詞並將其自然地融入履歷中。這有助於通過自動篩選系統。
            </p>
          </CollapsibleSection>
          <CollapsibleSection title="針對性客製化">
            <p>
              為每個應徵的職位客製化履歷。即使是同一行業，不同公司或職位對能力和經驗的側重可能不同。
            </p>
          </CollapsibleSection>
        </SectionCard>

        <div v-if="userId" class="mt-8 text-center text-sm text-gray-500">
          您的 Firebase 使用者 ID: <span class="font-mono text-gray-700">{{ userId }}</span>
        </div>
      </div>
    </div>
  `,
});

// 預約免費諮詢頁組件 (ConsultationPage)
const ConsultationPage = defineComponent({
  props: {
    user: Object, // 傳遞 user 物件以預填 email
    showSuccessMessage: Boolean, // 接收來自父組件的成功訊息顯示狀態
  },
  emits: ['bookingSuccess'],
  setup(props, { emit }) {
    const formData = reactive({
      name: '',
      email: props.user?.email || '', // 預填使用者 email
      topic: '',
      date: '',
      time: '',
    });
    const isSubmitting = ref(false);

    // 更新表單資料
    const handleChange = (e) => {
      const { name, value } = e.target;
      formData[name] = value;
    };

    // 處理表單提交
    const handleSubmit = async (e) => {
      e.preventDefault();
      // 由於模擬登入完成，這裡不再阻擋匿名使用者提交，但可以加入提示
      if (!props.user) {
         console.warn("匿名使用者提交諮詢，建議登入以確保資料可追溯。");
      }
      isSubmitting.value = true;
      try {
        // 使用戶 ID 作為集合路徑的一部分
        const userId = auth.currentUser?.uid || crypto.randomUUID(); // 對於匿名使用者使用隨機 ID
        const collectionPath = `/artifacts/${appId}/public/data/consultations`;

        // 將預約資料新增到 Firestore
        await addDoc(collection(db, collectionPath), {
          ...formData,
          userId: userId, // 儲存使用者的 Firebase ID
          timestamp: new Date(),
        });

        emit('bookingSuccess'); // 觸發父組件的成功事件
        // 清空表單
        formData.name = '';
        formData.email = props.user?.email || '';
        formData.topic = '';
        formData.date = '';
        formData.time = '';
      } catch (error) {
        console.error("預約諮詢失敗:", error);
        alert("預約諮詢失敗，請稍後再試。");
      } finally {
        isSubmitting.value = false;
      }
    };

    return {
      formData,
      isSubmitting,
      handleChange,
      handleSubmit,
      showSuccessMessage: props.showSuccessMessage, // 暴露給模板
    };
  },
  template: `
    <div class="min-h-screen bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
      <div class="max-w-xl mx-auto bg-white p-8 rounded-xl shadow-lg">
        <h2 class="text-4xl font-bold text-blue-700 mb-8 text-center">預約免費諮詢 (15 分鐘)</h2>

        <div v-if="showSuccessMessage" class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 mb-6 rounded-lg shadow-md transition-opacity duration-500 animate-fade-in">
          <p class="font-bold text-lg">預約成功！</p>
          <p>我們將盡快與您聯繫確認細節。</p>
        </div>

        <form @submit="handleSubmit" class="space-y-6">
          <div>
            <label for="name" class="block text-gray-700 text-lg font-medium mb-2">
              姓名 <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="name"
              name="name"
              v-model="formData.name"
              @input="handleChange"
              required
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200 text-gray-800"
            />
          </div>

          <div>
            <label for="email" class="block text-gray-700 text-lg font-medium mb-2">
              Email <span class="text-red-500">*</span>
            </label>
            <input
              type="email"
              id="email"
              name="email"
              v-model="formData.email"
              @input="handleChange"
              required
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200 text-gray-800"
            />
          </div>

          <div>
            <label for="topic" class="block text-gray-700 text-lg font-medium mb-2">
              諮詢主題 <span class="text-red-500">*</span>
            </label>
            <select
              id="topic"
              name="topic"
              v-model="formData.topic"
              @change="handleChange"
              required
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200 bg-white text-gray-800"
            >
              <option value="">請選擇</option>
              <option value="面試技巧">面試技巧</option>
              <option value="履歷撰寫">履歷撰寫</option>
              <option value="敬語使用">敬語使用</option>
              <option value="職涯規劃">職涯規劃</option>
              <option value="其他">其他</option>
            </select>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
            <div>
              <label for="date" class="block text-gray-700 text-lg font-medium mb-2">
                希望預約日期 <span class="text-red-500">*</span>
              </label>
              <input
                type="date"
                id="date"
                name="date"
                v-model="formData.date"
                @input="handleChange"
                required
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200 text-gray-800"
              />
            </div>
            <div>
              <label for="time" class="block text-gray-700 text-lg font-medium mb-2">
                希望預約時間 <span class="text-red-500">*</span>
              </label>
              <input
                type="time"
                id="time"
                name="time"
                v-model="formData.time"
                @input="handleChange"
                required
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200 text-gray-800"
              />
            </div>
          </div>

          <button
            type="submit"
            :disabled="isSubmitting"
            class="w-full bg-blue-600 text-white px-6 py-3 rounded-full text-xl font-bold shadow-xl hover:bg-blue-700 transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center"
          >
            <template v-if="isSubmitting">
              <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              正在提交...
            </template>
            <template v-else>
              提交預約
            </template>
          </button>
        </form>
      </div>
    </div>
  `,
});
</script>

<style scoped>
/* Tailwind doesn't need explicit style blocks for global classes, but custom styles could go here if needed */
/* For animations: */
.animate-fade-in {
  animation: fadeIn 0.5s ease-out;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>
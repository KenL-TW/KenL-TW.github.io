<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API å’Œ OSI æ¨¡å‹æ•™å­¸</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .osi-layer {
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            background-color: #e5e7eb;
            border-bottom: 1px solid #d1d5db;
        }
        .handshake-packet {
            width: 25px;
            height: 25px;
            position: absolute;
            display: none;
            border-radius: 50%;
            background-color: #93c5fd;
            color: white;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 1s cubic-bezier(.42, 0, .58, 1.0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        /* New pulse animation */
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(147, 197, 253, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(147, 197, 253, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(147, 197, 253, 0); }
        }
        .pulse-animation {
            animation: pulse 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
        }
        /* Layer info text on the side */
        .layer-info {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            left: 105%; /* Position to the right of the layer */
            width: 240px; /* Adjust width as needed */
            background-color: #fff;
            padding: 12px;
            border-radius: 12px;
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            pointer-events: none;
            font-size: 0.8rem;
            line-height: 1.4;
            border: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .layer-info.active {
            opacity: 1;
        }
        .info-content p {
            margin: 0;
        }
        .info-data {
            font-weight: bold;
            color: #3b82f6;
            background-color: #eff6ff;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.7rem;
            text-align: center;
        }
        #network-line {
            height: 4px;
            background-color: #d1d5db;
            transition: background-color 1s ease-in-out;
            border-radius: 2px;
        }
        .network-active {
            background-color: #22c55e;
            box-shadow: 0 0 10px #22c55e, 0 0 20px #22c55e;
        }
        .back-fab {
        position: fixed;
        left: 1rem;
        bottom: 1rem;   /* å¯æ”¹ç‚º top: 1rem; è®Šæˆå·¦ä¸Šè§’æµ®å‹• */
        z-index: 1080;  /* é«˜æ–¼ä¸€èˆ¬å…§å®¹ï¼Œä½æ–¼ Offcanvas/Modal */
        padding: .75rem 1.25rem;
        }
        @media (max-width: 767.98px) {
        .back-fab {
            left: .75rem;
            bottom: .75rem;
            padding: .625rem 1rem;
        }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-6xl w-full flex flex-col items-center space-y-8">
        <h1 class="text-4xl font-bold text-center text-gray-800">API å’Œ OSI æ¨¡å‹æ•™å­¸</h1>
        <!-- å»ºè­°æ”¾åœ¨æ•™å­¸å…§å®¹æœ€ä¸Šæ–¹æˆ–æœ€ä¸‹æ–¹ -->
        <a href="../index.html"
        class="btn btn-primary btn-lg rounded-pill shadow back-fab d-none d-md-inline-flex"
        aria-label="è¿”å›é¦–é ï¼ˆå¿«æ·éµ Hï¼‰"
        aria-keyshortcuts="H">
        <i class="bi bi-house-door me-2"></i> å›é¦–é 
        </a>
        <p class="text-center text-gray-600 max-w-2xl">
            é€™å€‹äº’å‹•å¼å·¥å…·å°‡å¸¶æ‚¨äº†è§£ API è«‹æ±‚å¦‚ä½•åœ¨å®¢æˆ¶ç«¯å’Œä¼ºæœå™¨ä¹‹é–“å‚³è¼¸ã€‚é¸æ“‡ä¸€å€‹å…§å®¹é¡å‹å’Œå‚³è¼¸å”å®šï¼Œç„¶å¾Œé»æ“ŠæŒ‰éˆ•ç™¼é€è«‹æ±‚ã€‚
        </p>

        <!-- Main Content Area -->
        <div class="flex flex-col md:flex-row justify-between w-full items-center md:items-start space-y-8 md:space-y-0 md:space-x-8">

            <!-- Client Section -->
            <div class="flex-1 bg-gray-50 rounded-2xl p-6 shadow-inner border-4 border-dashed border-gray-300">
                <h2 class="text-2xl font-semibold text-center text-gray-700 mb-6">å®¢æˆ¶ç«¯ (Client)</h2>
                <div id="client-osi" class="space-y-2">
                    <!-- Layers will be dynamically added here -->
                </div>
            </div>

            <!-- OSI Model & Controls -->
            <div class="flex-none flex flex-col items-center space-y-6">
                <!-- Data Format Selector -->
                <div class="flex flex-col items-center space-y-2">
                    <label for="dataType" class="text-gray-700 font-medium">é¸æ“‡è³‡æ–™æ ¼å¼ï¼š</label>
                    <select id="dataType" class="bg-white border border-gray-300 rounded-md py-2 px-4 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="text">æ–‡å­— (JSON)</option>
                        <option value="image">åœ–ç‰‡ (JPG)</option>
                        <option value="video">å½±ç‰‡ (MP4)</option>
                    </select>
                </div>
                
                <!-- Protocol Selector -->
                <div class="flex flex-col items-center space-y-2">
                    <label for="protocolType" class="text-gray-700 font-medium">é¸æ“‡å‚³è¼¸å”å®šï¼š</label>
                    <select id="protocolType" class="bg-white border border-gray-300 rounded-md py-2 px-4 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="tcp">TCP (å¯é ) ğŸ”’</option>
                        <option value="udp">UDP (å¿«é€Ÿ) âš¡</option>
                    </select>
                </div>
                
                <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
                    <button id="successButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition transform hover:scale-105">
                        ç™¼é€æˆåŠŸè«‹æ±‚
                    </button>
                    <button id="404Button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition transform hover:scale-105">
                        ç™¼é€ 404 è«‹æ±‚
                    </button>
                    <button id="500Button" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition transform hover:scale-105">
                        ç™¼é€ 500 è«‹æ±‚
                    </button>
                </div>

                <div class="bg-yellow-100 text-yellow-800 font-medium py-3 px-6 rounded-lg text-sm text-center shadow-md border border-yellow-300 w-full md:w-auto">
                    <p id="statusMessage">é»æ“ŠæŒ‰éˆ•ï¼Œçœ‹è³‡æ–™å¦‚ä½•ç©¿è¶Š OSI æ¨¡å‹ï¼</p>
                </div>
                
                <!-- New Network Line -->
                <div class="w-full">
                    <div id="network-line"></div>
                </div>

                <div id="packet-container" class="relative w-full h-full">
                    <!-- Handshake packets -->
                    <div id="synPacket" class="handshake-packet">SYN</div>
                    <div id="synAckPacket" class="handshake-packet">SYN-ACK</div>
                    <div id="ackPacket" class="handshake-packet">ACK</div>
                </div>
            </div>

            <!-- Server Section -->
            <div class="flex-1 bg-gray-50 rounded-2xl p-6 shadow-inner border-4 border-dashed border-gray-300">
                <h2 class="text-2xl font-semibold text-center text-gray-700 mb-6">ä¼ºæœå™¨ (Server)</h2>
                <div id="server-osi" class="space-y-2">
                    <!-- Layers will be dynamically added here -->
                </div>
            </div>
        </div>
        
        <!-- New HTTP Status Code Table -->
        <div class="mt-12 w-full max-w-3xl">
            <h2 class="text-2xl font-semibold text-center text-gray-700 mb-4">å¸¸è¦‹ HTTP ç‹€æ…‹ç¢¼</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-500 rounded-lg shadow-md overflow-hidden">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-200">
                        <tr>
                            <th scope="col" class="py-3 px-6 rounded-tl-lg">ç‹€æ…‹ç¢¼</th>
                            <th scope="col" class="py-3 px-6">åç¨±</th>
                            <th scope="col" class="py-3 px-6 rounded-tr-lg">èªªæ˜</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="bg-white border-b hover:bg-gray-50">
                            <td class="py-4 px-6 font-medium text-green-600 whitespace-nowrap">200 OK</td>
                            <td class="py-4 px-6">æˆåŠŸ</td>
                            <td class="py-4 px-6">ä¼ºæœå™¨æˆåŠŸè™•ç†äº†è«‹æ±‚ã€‚</td>
                        </tr>
                        <tr class="bg-white border-b hover:bg-gray-50">
                            <td class="py-4 px-6 font-medium text-red-600 whitespace-nowrap">404 Not Found</td>
                            <td class="py-4 px-6">æœªæ‰¾åˆ°</td>
                            <td class="py-4 px-6">ä¼ºæœå™¨æ‰¾ä¸åˆ°æ‰€è«‹æ±‚çš„è³‡æºã€‚</td>
                        </tr>
                        <tr class="bg-white hover:bg-gray-50">
                            <td class="py-4 px-6 font-medium text-orange-600 whitespace-nowrap">500 Internal Server Error</td>
                            <td class="py-4 px-6">å…§éƒ¨ä¼ºæœå™¨éŒ¯èª¤</td>
                            <td class="py-4 px-6">ä¼ºæœå™¨åŸ·è¡Œè«‹æ±‚æ™‚ç™¼ç”Ÿäº†é æœŸä¹‹å¤–çš„éŒ¯èª¤ã€‚</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        // Use an IIFE (Immediately Invoked Function Expression) to avoid global scope pollution
        (function() {
            const layers = [
                {
                    name: 'æ‡‰ç”¨å±¤ (Layer 7)',
                    dataDisplay: {
                        text: 'ğŸ“ HTTP è«‹æ±‚ (JSON)',
                        image: 'ğŸ–¼ï¸ HTTP è«‹æ±‚ (JPG)',
                        video: 'ğŸ¬ HTTP è«‹æ±‚ (MP4)',
                        error404: 'ğŸš¨ 404 å›æ‡‰',
                        error500: 'ğŸš¨ 500 å›æ‡‰'
                    },
                    apiConcepts: {
                        request: `<strong>API çš„èµ·é»</strong>ï¼šAPI å°±åƒæ˜¯æœå‹™çš„èœå–®ã€‚ç•¶æ‚¨é»æ“Šç™¼é€è«‹æ±‚ï¼Œæ‡‰ç”¨ç¨‹å¼å±¤å°±æœƒç”¢ç”Ÿä¸€å€‹ HTTP è«‹æ±‚ã€‚é€™å±¤æ±ºå®šäº†è«‹æ±‚çš„é¡å‹ï¼ˆGETã€POST ç­‰ï¼‰å’Œç›®æ¨™ã€‚`,
                        response: `<strong>API çš„çµ‚é»</strong>ï¼šä¼ºæœå™¨è™•ç†å®Œè«‹æ±‚ï¼Œæœƒå‚³å›ä¸€å€‹ HTTP å›æ‡‰ã€‚é€™å€‹å›æ‡‰æœƒåŒ…å«ä¸€å€‹ã€Œç‹€æ…‹ç¢¼ã€èˆ‡æ‚¨è«‹æ±‚çš„è³‡æ–™ã€‚`
                    }
                },
                {
                    name: 'è¡¨ç¤ºå±¤ (Layer 6)',
                    dataDisplay: {
                        request: 'ğŸ“Š æ ¼å¼åŒ–è³‡æ–™',
                        response: 'ğŸ“Š è§£ç¢¼è³‡æ–™'
                    },
                    apiConcepts: {
                        request: `<strong>è³‡æ–™æ ¼å¼åŒ–</strong>ï¼šé€™å±¤æœƒå°‡æ‚¨çš„åŸå§‹è³‡æ–™ï¼ˆä¾‹å¦‚ä¸€å¼µåœ–ç‰‡ï¼‰è½‰æ›ç‚ºæ¨™æº–çš„ç¶²è·¯æ ¼å¼ï¼Œä¾‹å¦‚ JSON æˆ– XMLã€‚é€™å°±åƒæ˜¯æ‰“åŒ…ç¦®ç‰©ï¼Œç¢ºä¿æ”¶ä»¶äººèƒ½æ­£ç¢ºæ‰“é–‹ã€‚`,
                        response: `<strong>è³‡æ–™è§£ç¢¼</strong>ï¼šæ”¶åˆ°çš„è³‡æ–™åœ¨é€™è£¡è¢«è§£ç¢¼ï¼Œä¾‹å¦‚å°‡ JSON å­—ä¸²è§£æç‚ºæ‡‰ç”¨ç¨‹å¼èƒ½è®€æ‡‚çš„ç‰©ä»¶ã€‚é€™å±¤ä¹Ÿè² è²¬è§£å¯† HTTPS è«‹æ±‚ä¸­çš„è³‡æ–™ã€‚`
                    }
                },
                {
                    name: 'æœƒè©±å±¤ (Layer 5)',
                    dataDisplay: {
                        request: 'ğŸ¤ æœƒè©±è³‡æ–™',
                        response: 'ğŸ¤ æœƒè©±è³‡æ–™'
                    },
                    apiConcepts: {
                        request: `<strong>å»ºç«‹æœƒè©±</strong>ï¼šAPI è«‹æ±‚ç¶“å¸¸éœ€è¦ä¿æŒä¸€å€‹ã€Œæœƒè©±ã€ï¼Œä»¥ç¢ºä¿è³‡æ–™å®Œæ•´åœ°å‚³è¼¸ã€‚é€™å±¤å°±åƒæ˜¯é–‹å§‹ä¸€æ¬¡é›»è©±äº¤è«‡ï¼Œç¢ºä¿é›™æ–¹éƒ½æº–å‚™å¥½æ¥æ”¶å’Œç™¼é€è³‡æ–™ã€‚`,
                        response: `<strong>ç®¡ç†æœƒè©±</strong>ï¼šå®ƒç¢ºä¿è«‹æ±‚èˆ‡å›æ‡‰æ˜¯æˆå°çš„ï¼Œä¸¦ä¸”åœ¨å‚³è¼¸å®Œæˆå¾Œæ­£ç¢ºåœ°çµæŸé€£ç·šï¼Œä»¥é‡‹æ”¾è³‡æºã€‚`
                    }
                },
                {
                    name: 'å‚³è¼¸å±¤ (Layer 4)',
                    dataDisplay: {
                        request: 'ğŸ“¦ TCP Segments / UDP Datagrams',
                        response: 'ğŸ“¦ TCP Segments / UDP Datagrams'
                    },
                    apiConcepts: {
                        request: `<strong>å¯é æ€§èˆ‡é€Ÿåº¦</strong>ï¼šé€™å±¤æ±ºå®šäº†è³‡æ–™å‚³è¼¸çš„å”å®šã€‚<strong>TCP</strong> (å¯é ) å°±åƒæ˜¯ç™¼é€å¸¶æœ‰å›åŸ·çš„åŒ…è£¹ï¼Œç¢ºä¿æ¯å€‹æ®µéƒ½é€é”ï¼›è€Œ <strong>UDP</strong> (å¿«é€Ÿ) å‰‡åƒæ˜¯å¯„æ˜ä¿¡ç‰‡ï¼Œä¸ä¿è­‰é€é”ä½†é€Ÿåº¦æ¥µå¿«ã€‚`,
                        response: `<strong>é‡æ–°çµ„è£è³‡æ–™</strong>ï¼šæ”¶åˆ°çš„è³‡æ–™æ®µ (Segments) åœ¨é€™è£¡è¢«é‡æ–°çµ„åˆï¼Œä¸¦æª¢æŸ¥æ˜¯å¦æœ‰éºå¤±æˆ–éŒ¯èª¤ã€‚`
                    }
                },
                {
                    name: 'ç¶²è·¯å±¤ (Layer 3)',
                    dataDisplay: {
                        request: 'ğŸŒ IP å°åŒ…',
                        response: 'ğŸŒ IP å°åŒ…'
                    },
                    apiConcepts: {
                        request: `<strong>å°‹æ‰¾ç›®æ¨™</strong>ï¼šé€™å±¤æ˜¯ç¶²éš›ç¶²è·¯çš„ GPSã€‚å®ƒæœƒåŠ å…¥ IP ä½å€ï¼Œå‘Šè¨´å°åŒ…è¦é€å¾€å“ªä¸€å€‹ä¼ºæœå™¨ã€‚é€™ç¢ºä¿äº†æ‚¨çš„è«‹æ±‚èƒ½è¢«è·¯ç”±åˆ°æ­£ç¢ºçš„ç›®çš„åœ°ã€‚`,
                        response: `<strong>æ¥æ”¶èˆ‡è½‰é€</strong>ï¼šç•¶å°åŒ…é€é”æ™‚ï¼Œé€™å±¤æœƒè®€å–ç›®æ¨™ IPï¼Œç¢ºèªå°åŒ…æ˜¯çµ¦è‡ªå·±çš„ï¼Œç„¶å¾Œå¾€ä¸Šå‚³é€ã€‚`
                    }
                },
                {
                    name: 'è³‡æ–™é€£çµå±¤ (Layer 2)',
                    dataDisplay: {
                        request: 'ğŸ–¼ï¸ ä¹™å¤ªç¶²è¨Šæ¡†',
                        response: 'ğŸ–¼ï¸ ä¹™å¤ªç¶²è¨Šæ¡†'
                    },
                    apiConcepts: {
                        request: `<strong>å€åŸŸç¶²è·¯å‚³è¼¸</strong>ï¼šé€™å±¤è™•ç†åŒä¸€ç¶²è·¯ä¸­çš„è³‡æ–™å‚³è¼¸ï¼Œæ¯”å¦‚æ‚¨å®¶ä¸­çš„è·¯ç”±å™¨ã€‚å®ƒä½¿ç”¨ MAC ä½å€ä¾†æ¨™è­˜ç¶²è·¯å¡ï¼Œä¸¦å°‡è³‡æ–™å°è£æˆè¨Šæ¡†ã€‚`,
                        response: `<strong>éŒ¯èª¤æª¢æŸ¥</strong>ï¼šé€™å±¤æœƒå°æ”¶åˆ°çš„è¨Šæ¡†é€²è¡ŒéŒ¯èª¤æª¢æ¸¬ï¼Œç¢ºä¿è³‡æ–™åœ¨å€åŸŸç¶²è·¯ä¸­å‚³è¼¸æ™‚æ²’æœ‰æå£ã€‚`
                    }
                },
                {
                    name: 'å¯¦é«”å±¤ (Layer 1)',
                    dataDisplay: {
                        request: 'â¡ï¸ ä½å…ƒæµ',
                        response: 'â¡ï¸ ä½å…ƒæµ'
                    },
                    apiConcepts: {
                        request: `<strong>ç‰©ç†å‚³è¼¸</strong>ï¼šé€™æ˜¯ API è«‹æ±‚æœ€åº•å±¤çš„ç‰©ç†å‚³è¼¸ï¼Œå°‡è³‡æ–™è½‰æ›ç‚ºå…‰çº–æˆ–é›»çºœä¸­çš„é›»è¨Šè™Ÿã€‚é€™å°±åƒæ˜¯è³‡æ–™åœ¨ç¶²ç·šä¸­ä»¥å…‰é€Ÿå‚³è¼¸ã€‚`,
                        response: `<strong>ç‰©ç†æ¥æ”¶</strong>ï¼šé€™å±¤å°‡ç‰©ç†è¨Šè™Ÿè½‰æ›å›æ•¸ä½ä½å…ƒæµï¼Œæº–å‚™å¥½å‘ä¸Šå‚³éçµ¦è³‡æ–™é€£çµå±¤ã€‚`
                    }
                },
            ];

            const clientOsi = document.getElementById('client-osi');
            const serverOsi = document.getElementById('server-osi');
            const successButton = document.getElementById('successButton');
            const button404 = document.getElementById('404Button');
            const button500 = document.getElementById('500Button');
            const statusMessage = document.getElementById('statusMessage');
            const dataTypeSelector = document.getElementById('dataType');
            const protocolTypeSelector = document.getElementById('protocolType');
            const synPacket = document.getElementById('synPacket');
            const synAckPacket = document.getElementById('synAckPacket');
            const ackPacket = document.getElementById('ackPacket');
            const networkLine = document.getElementById('network-line');
            let isAnimating = false;

            const createLayers = (container) => {
                layers.forEach((layer) => {
                    const layerDiv = document.createElement('div');
                    layerDiv.className = `osi-layer rounded-lg border-2 border-gray-300 text-sm md:text-base font-semibold transition-colors duration-500 ease-in-out`;
                    layerDiv.innerHTML = `<div class="w-full text-center">${layer.name}</div><div class="layer-info"><div class="info-content"></div><div class="info-data"></div></div>`;
                    container.appendChild(layerDiv);
                });
            };

            createLayers(clientOsi);
            createLayers(serverOsi);

            const clientLayers = document.querySelectorAll('#client-osi .osi-layer');
            const serverLayers = document.querySelectorAll('#server-osi .osi-layer');
            const allButtons = document.querySelectorAll('button');

            const resetUI = () => {
                synPacket.style.display = 'none';
                synAckPacket.style.display = 'none';
                ackPacket.style.display = 'none';
                synPacket.style.transform = 'translateY(0) translateX(0)';
                synAckPacket.style.transform = 'translateY(0) translateX(0)';
                ackPacket.style.transform = 'translateY(0) translateX(0)';
                networkLine.classList.remove('network-active');
                document.querySelectorAll('.osi-layer').forEach(el => {
                    el.style.backgroundColor = '#e5e7eb';
                    el.classList.remove('pulse-animation');
                });
                document.querySelectorAll('.layer-info').forEach(infoEl => {
                    infoEl.classList.remove('active');
                });
                statusMessage.innerHTML = '<strong>é»æ“ŠæŒ‰éˆ•ï¼Œçœ‹è³‡æ–™å¦‚ä½•ç©¿è¶Š OSI æ¨¡å‹ï¼</strong>';
                allButtons.forEach(btn => btn.disabled = false);
                isAnimating = false;
            };

            const animateLayers = async (layerElements, type, requestType = 'success') => {
                const isRequest = (type === 'request');
                const start = isRequest ? 0 : layers.length - 1;
                const end = isRequest ? layers.length : -1;
                const step = isRequest ? 1 : -1;

                for (let i = start; i !== end; i += step) {
                    const layer = layers[i];
                    const layerEl = layerElements[i];
                    const infoContentEl = layerEl.querySelector('.info-content');
                    const infoDataEl = layerEl.querySelector('.info-data');

                    layerEl.classList.add('pulse-animation');
                    layerEl.style.backgroundColor = isRequest ? '#93c5fd' : '#86efac';

                    infoContentEl.innerHTML = layer.apiConcepts[type] || '';

                    let dataText = '';
                    if (isRequest && i === 0) { // Application Layer on request
                        dataText = layer.dataDisplay[dataTypeSelector.value];
                    } else if (!isRequest && i === layers.length - 1) { // Physical Layer on response
                        dataText = layer.dataDisplay[type];
                    } else if (isRequest && i === layers.length - 1) { // Physical Layer on request
                        dataText = layer.dataDisplay[type];
                    } else if (!isRequest && i === 0) { // Application Layer on response
                        dataText = layer.dataDisplay[requestType === 'success' ? dataTypeSelector.value : `error${requestType}`];
                    } else { // All other layers
                        dataText = layer.dataDisplay[type];
                    }

                    infoDataEl.textContent = dataText;

                    const layerInfoEl = layerEl.querySelector('.layer-info');
                    layerInfoEl.classList.add('active');

                    await new Promise(resolve => setTimeout(resolve, 1500));

                    layerEl.style.backgroundColor = '#e5e7eb';
                    layerEl.classList.remove('pulse-animation');
                    layerInfoEl.classList.remove('active');
                }
            };

            const startAnimation = async (requestType) => {
                if (isAnimating) return;
                isAnimating = true;
                allButtons.forEach(btn => btn.disabled = true);

                const protocolType = protocolTypeSelector.value;
                const protocolIcon = protocolType === 'tcp' ? 'ğŸ”’' : 'âš¡';

                statusMessage.innerHTML = `ä½¿ç”¨ ${protocolType.toUpperCase()} å”å®š ${protocolIcon}...`;

                if (protocolType === 'tcp') {
                    await animateHandshake();
                }

                statusMessage.innerHTML = `è³‡æ–™åœ¨å®¢æˆ¶ç«¯æº–å‚™ä¸­...`;
                await animateLayers(clientLayers, 'request');

                statusMessage.innerHTML = `è³‡æ–™ç©¿è¶Šç¶²è·¯... ${protocolIcon}`;
                networkLine.classList.add('network-active');
                await new Promise(resolve => setTimeout(resolve, 2000));
                networkLine.classList.remove('network-active');

                statusMessage.innerHTML = `è³‡æ–™åœ¨ä¼ºæœå™¨è™•ç†ä¸­...`;
                await animateLayers(serverLayers, 'request', requestType);

                if (requestType === 'success') {
                    statusMessage.innerHTML = 'ä¼ºæœå™¨è™•ç†è«‹æ±‚ä¸¦æº–å‚™å›æ‡‰...';
                    await new Promise(resolve => setTimeout(resolve, 1000));

                    statusMessage.innerHTML = `å›æ‡‰åœ¨ä¼ºæœå™¨æº–å‚™ä¸­...`;
                    await animateLayers(serverLayers, 'response');

                    statusMessage.innerHTML = `å›æ‡‰ç©¿è¶Šç¶²è·¯... ${protocolIcon}`;
                    networkLine.classList.add('network-active');
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    networkLine.classList.remove('network-active');

                    statusMessage.innerHTML = `å›æ‡‰åœ¨å®¢æˆ¶ç«¯è™•ç†ä¸­...`;
                    await animateLayers(clientLayers, 'response');
                } else {
                    statusMessage.innerHTML = `<strong>ä¼ºæœå™¨éŒ¯èª¤ï¼</strong><br><span style="color:#ef4444;">${layers[0].dataDisplay[`error${requestType}`]}</span>`;
                    await new Promise(resolve => setTimeout(resolve, 2000));

                    statusMessage.innerHTML = `éŒ¯èª¤å›æ‡‰åœ¨ä¼ºæœå™¨æº–å‚™ä¸­...`;
                    await animateLayers(serverLayers, 'response', requestType);

                    statusMessage.innerHTML = `éŒ¯èª¤å›æ‡‰ç©¿è¶Šç¶²è·¯... ${protocolIcon}`;
                    networkLine.classList.add('network-active');
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    networkLine.classList.remove('network-active');

                    statusMessage.innerHTML = `éŒ¯èª¤å›æ‡‰åœ¨å®¢æˆ¶ç«¯è™•ç†ä¸­...`;
                    await animateLayers(clientLayers, 'response', requestType);
                }

                statusMessage.innerHTML = 'æ•™å­¸å®Œæˆï¼';
                await new Promise(resolve => setTimeout(resolve, 1500));
                resetUI();
            };

            const animateHandshake = async () => {
                const clientY = clientLayers[3].offsetTop + (clientLayers[3].offsetHeight / 2) - (synPacket.offsetHeight / 2);
                const serverY = serverLayers[3].offsetTop + (serverLayers[3].offsetHeight / 2) - (synAckPacket.offsetHeight / 2);
                const clientX = clientLayers[3].offsetLeft;
                const serverX = serverLayers[3].offsetLeft;

                statusMessage.innerHTML = `TCP: å®¢æˆ¶ç«¯ç™¼é€ SYN (åŒæ­¥) è«‹æ±‚ ${'ğŸ”’'}`;
                synPacket.style.display = 'flex';
                synPacket.style.transform = `translateY(0) translateX(0)`;
                networkLine.classList.add('network-active');
                await new Promise(resolve => setTimeout(resolve, 500));
                synPacket.style.transform = `translate(${serverX - clientX}px, ${serverY - clientY}px)`;
                await new Promise(resolve => setTimeout(resolve, 1000));
                networkLine.classList.remove('network-active');
                synPacket.style.display = 'none';

                statusMessage.innerHTML = `TCP: ä¼ºæœå™¨ç™¼é€ SYN-ACK å›æ‡‰ ${'ğŸ”’'}`;
                synAckPacket.style.display = 'flex';
                synAckPacket.style.transform = `translate(${serverX - clientX}px, ${serverY - clientY}px)`;
                networkLine.classList.add('network-active');
                await new Promise(resolve => setTimeout(resolve, 500));
                synAckPacket.style.transform = `translate(0, 0)`;
                await new Promise(resolve => setTimeout(resolve, 1000));
                networkLine.classList.remove('network-active');
                synAckPacket.style.display = 'none';

                statusMessage.innerHTML = `TCP: å®¢æˆ¶ç«¯ç™¼é€ ACK (ç¢ºèª) å›æ‡‰ï¼Œé€£ç·šå»ºç«‹ ${'ğŸ”’'}`;
                ackPacket.style.display = 'flex';
                ackPacket.style.transform = `translateY(0) translateX(0)`;
                networkLine.classList.add('network-active');
                await new Promise(resolve => setTimeout(resolve, 500));
                ackPacket.style.transform = `translate(${serverX - clientX}px, ${serverY - clientY}px)`;
                await new Promise(resolve => setTimeout(resolve, 1000));
                networkLine.classList.remove('network-active');
                ackPacket.style.display = 'none';

                statusMessage.innerHTML = 'TCP é€£ç·šå·²å»ºç«‹ã€‚æº–å‚™ç™¼é€è³‡æ–™ã€‚';
                await new Promise(resolve => setTimeout(resolve, 1000));
            };

            successButton.addEventListener('click', () => startAnimation('success'));
            button404.addEventListener('click', () => startAnimation('404'));
            button500.addEventListener('click', () => startAnimation('500'));

            resetUI();
        })();
    </script>
</body>
</html>
